<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Analysis Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z'%3e%3c/path%3e%3c/svg%3e">
  </head>
  <body>
    <div id="root"></div>

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX Transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useCallback } = React;

      // --- SERVICES ---
      const TEMPLATE_URLS = [
        'https://cdn.jsdelivr.net/gh/mrarogiewicz/prompts@main/stock_analysis_detail.md',
        'https://raw.githubusercontent.com/mrarogiewicz/prompts/main/stock_analysis_detail.md',
        'https://raw.githack.com/mrarogiewicz/prompts/main/stock_analysis_detail.md'
      ];

      const fetchTemplate = async () => {
        for (const url of TEMPLATE_URLS) {
          try {
            const response = await fetch(url, {
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache'
            });

            if (response.ok) {
              const template = await response.text();
              if (template && template.includes('XXX') && template.length > 500) {
                return template;
              }
            }
          } catch (err) {
            console.warn(`Failed to fetch from ${url}:`, err);
          }
        }
        throw new Error('Could not fetch template from any available source.');
      };

      // --- HOOKS ---
      const useTemplateGenerator = () => {
        const [ticker, setTicker] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [generatedContent, setGeneratedContent] = useState('');

        const generateTemplate = useCallback(async () => {
          if (!ticker.trim()) {
            setError('Please enter a stock ticker');
            return;
          }

          setIsLoading(true);
          setError(null);
          setGeneratedContent('');

          try {
            const template = await fetchTemplate();
            const content = template.replace(/XXX/g, ticker.toUpperCase());
            setGeneratedContent(content);
          } catch (err) {
            console.error('Fetch error:', err);
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(`Unable to fetch template. ${errorMessage}`);
            setGeneratedContent('');
          } finally {
            setIsLoading(false);
          }
        }, [ticker]);
        
        const handleSetTicker = (value) => {
          setTicker(value.toUpperCase());
          if (error) setError(null);
          if (generatedContent) setGeneratedContent('');
        };

        return {
          ticker,
          setTicker: handleSetTicker,
          isLoading,
          error,
          generatedContent,
          generateTemplate,
        };
      };

      // --- ICONS ---
      const ChartIcon = (props) => (
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
      );

      const GenerateIcon = (props) => (
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      );

      const CheckIcon = (props) => (
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
        </svg>
      );

      const CopyIcon = (props) => (
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      );
      
      const PerplexityIcon = (props) => (
        <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" fill="none" {...props}>
          <path d="M12 2V22 M12 2L18 7V17L12 22L6 17V7L12 2Z M6 7L18 17 M18 7L6 17" />
        </svg>
      );

      const Spinner = (props) => (
        <svg
          {...props}
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          className={`animate-spin ${props.className || ''}`}
        >
          <circle
            className="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            strokeWidth="4"
          ></circle>
          <path
            className="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      );
      
      // --- COMPONENTS ---
      const Header = () => {
        return (
          <header className="text-center mb-8">
            <div className="inline-flex items-center justify-center gap-3 mb-4">
              <ChartIcon className="w-8 h-8 text-gray-600" />
              <h1 className="text-3xl font-bold text-gray-800">Stock Analysis Generator</h1>
            </div>
          </header>
        );
      };

      const InputForm = ({ ticker, setTicker, isLoading, onSubmit }) => {
        const handleSubmit = (e) => {
          e.preventDefault();
          onSubmit();
        };
          
        return (
          <form onSubmit={handleSubmit} className="space-y-4">
            <label htmlFor="tickerInput" className="block text-gray-700 font-medium mb-2 text-center">
              Enter stock ticker
            </label>
            <input
              id="tickerInput"
              type="text"
              value={ticker}
              onChange={(e) => setTicker(e.target.value)}
              placeholder="e.g., AAPL"
              maxLength={10}
              className="w-full px-4 py-3 bg-white/80 border border-gray-300 rounded-xl text-gray-800 text-base placeholder-gray-400 focus:ring-2 focus:ring-gray-400 focus:border-gray-500 outline-none transition duration-200 text-center"
            />
            <button
              type="submit"
              disabled={isLoading || !ticker.trim()}
              className="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-semibold text-white bg-gray-700 hover:bg-gray-800 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200"
            >
              {isLoading ? (
                <React.Fragment>
                  <Spinner className="w-5 h-5" />
                  Processing...
                </React.Fragment>
              ) : (
                <React.Fragment>
                  <GenerateIcon className="w-5 h-5" />
                  Generate Template
                </React.Fragment>
              )}
            </button>
          </form>
        );
      };

      const ErrorMessage = ({ message }) => {
        if (!message) return null;
        return (
          <div className="mt-4 bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
            {message}
          </div>
        );
      };

      const SuccessDisplay = ({ ticker, content }) => {
        const [isCopied, setIsCopied] = useState(false);
        const [isPerplexityBusy, setIsPerplexityBusy] = useState(false);

        const handleCopy = useCallback(async () => {
          try {
            await navigator.clipboard.writeText(content);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
          } catch (err) {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy to clipboard.');
          }
        }, [content]);

        const perplexityUrl = 'https://perplexity.ai/search';

        const handlePerplexityClick = useCallback(async (e) => {
            e.preventDefault();
            setIsPerplexityBusy(true);

            try {
                await navigator.clipboard.writeText(content);
            } catch (err) {
                console.error('Failed to copy text to clipboard:', err);
            }

            window.location.assign(perplexityUrl);

            setTimeout(() => setIsPerplexityBusy(false), 2500);
        }, [content]);

        return (
          <div className="max-w-md mx-auto">
            <div className="bg-white/90 backdrop-blur-md rounded-2xl p-6 border border-gray-200 shadow-lg">
              <div className="text-center mb-4">
                <div className="inline-flex items-center gap-2 text-green-600 font-medium">
                  <CheckIcon className="w-5 h-5" />
                  <span>Template ready for ticker - {ticker}</span>
                </div>
              </div>
              <div className="flex flex-col sm:flex-row gap-3">
                <button
                    onClick={handleCopy}
                    className="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200"
                >
                    {isCopied ? (
                    <React.Fragment>
                        <CheckIcon className="w-5 h-5" />
                        Copied!
                    </React.Fragment>
                    ) : (
                    <React.Fragment>
                        <CopyIcon className="w-5 h-5" />
                        Copy
                    </React.Fragment>
                    )}
                </button>
                <a
                    href={perplexityUrl}
                    onClick={handlePerplexityClick}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-semibold text-white bg-black hover:bg-gray-800 transition-colors duration-200"
                >
                    {isPerplexityBusy ? (
                        <React.Fragment>
                            <CheckIcon className="w-5 h-5" />
                            Copied & Opening...
                        </React.Fragment>
                    ) : (
                        <React.Fragment>
                            <PerplexityIcon className="w-5 h-5" />
                            Perplexity
                        </React.Fragment>
                    )}
                </a>
              </div>
            </div>
          </div>
        );
      };
      
      const Preview = ({ content }) => {
        return (
          <div className="mt-8 max-w-4xl mx-auto">
            <details className="bg-white/90 backdrop-blur-md rounded-2xl border border-gray-200 shadow-lg overflow-hidden">
              <summary className="p-4 text-gray-700 font-medium cursor-pointer hover:bg-gray-50 transition-colors">
                Preview Content (Click to expand)
              </summary>
              <div className="p-4 border-t border-gray-200">
                <pre className="text-xs text-gray-600 whitespace-pre-wrap break-words max-h-96 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                  {content}
                </pre>
              </div>
            </details>
          </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
        const {
          ticker,
          setTicker,
          isLoading,
          error,
          generatedContent,
          generateTemplate,
        } = useTemplateGenerator();

        return (
          <main className="min-h-screen bg-[#f8f9fa] from-[#f8f9fa] via-[#e9ecef] to-[#f8f9fa] bg-gradient-to-br font-sans text-gray-800">
            <div className="container mx-auto px-4 py-8">
              <Header />

              <div className="max-w-md mx-auto mb-8">
                  <div className="bg-white/90 backdrop-blur-md rounded-2xl p-6 border border-gray-200 shadow-lg">
                      <InputForm
                          ticker={ticker}
                          setTicker={setTicker}
                          isLoading={isLoading}
                          onSubmit={generateTemplate}
                      />
                      <ErrorMessage message={error} />
                  </div>
              </div>

              {generatedContent && !error && (
                  <React.Fragment>
                      <SuccessDisplay ticker={ticker} content={generatedContent} />
                      <Preview content={generatedContent} />
                  </React.Fragment>
              )}
            </div>
          </main>
        );
      };

      // --- RENDER ---
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>